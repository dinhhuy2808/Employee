<!DOCTYPE HTML>
<html>
<%- include layout/header.ejs %>
<body>


<div class="mid">
    <div><b><%= data.fname %></b>&nbsp;|&nbsp;<a href="/logout">Logout</a></div>
    <h1>Add Todo List</h1>
    <form action="save-task" novalidate  method="post">


    <table>
        <tr>
            <td>
                <label>Task Code</label>
                <input name="taskcode" id="taskcode" value='<%= tasks[0].task_code %>' required >
            </td>
            <td>
                <input name="task_id" id="task_id" value='<%= tasks[0].task_id %>' required style="display: none" >
            </td>
        </tr>
        <tr>
            <td>
                <label>Desciption</label>
                <textarea type="text" name="description" id="description" value='<%= tasks[0].description %>' required></textarea>
            </td>

        </tr>
        <tr>
            <td>
                <label>Assignee</label>
                <%if(data.type == 1){%>
                    <input type="text" name="email" id="email" value='<%= tasks[0].assignee_email %>' required>
                <%} else {%>
                <select name="email" id="email" onchange="ChangeThis()">
                        <%if(tasks[0].assignee_email != null){%>

                            <option value="" selected></option>

                            <option value="me" selected><%= tasks[0].assignee_email %></option>
                        <%} else {%>

                            <option value="" selected></option>

                            <option value="me">Assign to me</option>

                        <%}%>

                </select>
                <%}%>

            </td>
            <td>
                <label>Customer Name</label>
                <input type="text" name="name" id="name" value='<%= tasks[0].assignee_firstname  + ' ' + tasks[0].assignee_lastname%>' disabled>
            </td>
            <td>
                <input type="text" name="assignee_id" id="assignee_id" value='<%= tasks[0].assignee_id %>' style="display: none">
            </td>
        </tr>
        <tr>
            <td>
                <label>Estimate</label>
                <input type="text" name="estimate" id="estimate" value='<%= tasks[0].estimate %>' required>
            </td>
        </tr>
        <tr>
            <td>
                <label>Work Log</label>
                <input type="text" name="log" id="log" value='<%= tasks[0].log_work %>' required >
            </td>
        </tr>
        <tr>
            <td>
                <label>Status</label>
                <select name="status" id="status">
                    <% for (var i = 0;i<data.status.length;i++){%>
                    <%if(data.status[i].status_id == tasks[0].status_id){%>
                    <option value="<%=data.status[i].status_id%>" selected><%=data.status[i].description%></option>
                    <%} else {%>
                    <option value="<%=data.status[i].status_id%>"><%=data.status[i].description%></option>
                    <%}%>
                    <%}%>

                </select>
            </td>
        </tr>
        <tr>

            <td>
                <label>Approved</label>
                <%if(data.type == 1) {%>
                    <select name="approved" id="approved">
                        <option value="N" selected>No</option>
                        <option value="Y">Yes</option>
                    </select>
                <%} else {%>
                    <select name="approved" id="approved" disabled>
                        <option value="N" selected>No</option>
                        <option value="Y">Yes</option>
                    </select>
                <%}%>

            </td>
        </tr>
        <tr>
            <td>
                <label>Creator</label>
                <input type="text" name="creator" id="creator" value='<%= tasks[0].reporter_firstname + ' '+tasks[0].reporter_lastname %>' required disabled>
            </td>
            <td>
                <input type="text" name="creator_id" id="creator_id" value='<%= tasks[0].reporter_id %>'style="display: none">
            </td>
            <td>
                <input type="text" name="project_id" id="project_id" value='<%= tasks[0].project_id %>'style="display: none">
            </td>
            <td>
                <input type="text" name="action" id="action" value = 'edit' style="display: none">
            </td>
        </tr>
    </table>
        <input value="Add" id="add" type="submit">
    </form>


</div>
</body>
<script type="text/javascript">
    $(document).ready(function () {
        /*$('#email').keyup(function () {
            $(".error").remove();
            var obj = $(this);
            if (obj.val().trim() != '') {
                $.ajax({
                    type: "POST",
                    url: "./ajax/checkEmailAddProject",
                    data: "mode=checkEmailAddProject&email=" + obj.val(),
                    success: function (msg) {
                        //alert(msg);
                        data = msg;
                        if (data.status == 'exist') {
                            /!* obj.after("<label class='error'>Email Id Aleady Exist</label>");*!/
                            /!*$("#frmId .btn").attr('disabled', 'disabled');*!/
                            document.getElementById('name').value = data.name;
                            document.getElementById('assignee_id').value = data.user_id;
                            document.getElementById('add').style.display = 'block';
                        }
                        else {
                            document.getElementById('name').value = '';
                            document.getElementById('add').style.display = 'none';
                            /!* $("#frmId .btn").removeAttr('disabled');*!/
                        }
                    }
                });
            } else {
                document.getElementById('add').style.display = 'block';
            }

        });*/

    });

    $(document).ready(function () {
        $('#code').keyup(function () {
            $(".error").remove();
            var obj = $(this);
            $.ajax({
                type: "POST",
                url: "./ajax/checkProjectCode",
                data: "mode=checkProjectCode&code=" + obj.val(),
                success: function (msg) {
                    //alert(msg);
                    data = msg;
                    if (data.status == 'exist') {
                        obj.after("<label class='error'>Project Code Is Aleady Exist</label>");
                        document.getElementById('add').style.display = 'none';
                        /*$("#frmId .btn").attr('disabled', 'disabled');*/
                        /* document.getElementById('name').value = data.name;*/
                        /*document.getElementById('add').style.display = 'block';*/
                    }
                    else {
                        /* $("#frmId .btn").removeAttr('disabled');*/
                        document.getElementById('add').style.display = 'block';
                    }
                }
            });
        });

    });
</script>
<script language="javascript">
    $("#approved").val('<%=tasks[0].approved%>');
    if (document.getElementById('email').value.trim() == '') {
        document.getElementById('add').style.display = 'block';
    }
    function  buttonAdd() {
        var value = getSearchParams('project_id');
        document.getElementById('project_id').value = value;
    }
    function getSearchParams(k){
        var p={};
        location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(s,k,v){p[k]=v})
        return k?p[k]:p;
    }

    function ChangeThis(){
        var value = document.getElementById('email').value;
        if(value == 'me'){
            document.getElementById('assignee_id').value = "<%=data.userid%>";
            document.getElementById('name').value = "<%= data.fname + ' '+data.lname%>";
        }else{
            document.getElementById('assignee_id').value = "0";
        }

    }
   /* function DoPost() {

        var varTaskCode = document.getElementById('taskcode').value;
        var varDescription = document.getElementById('description').value;
        var varAssignee = document.getElementById('userid').value;
        var varEstimate = document.getElementById('estimate').value;
        var varLog = document.getElementById('log').value;
        var varStatus = document.getElementById('status').value;
        var varApproved = document.getElementById('approved').value;
        var varCreator = document.getElementById('creator').value;

        if (varDescription.trim() == '') {
            $(".error").remove();
            $(document.getElementById('description')).after("<label class='error'>This Is Mandatory Field</label>")
        } else {
            $.post("save-task", {
                taskcode: varTaskCode,
                description: varDescription,
                assignee_id: varAssignee,
                estimate: varEstimate,
                log: varLog,
                status: varStatus,
                approved: varApproved,
                creator: varCreator,
                creator_id: document.getElementById('creatorid').value,
                project_id: getSearchParams('project_id'),
                action : 'save'
            });  //Your values here..
        }

    }*/

</script>

<%- include layout/footer.ejs %>
</html>